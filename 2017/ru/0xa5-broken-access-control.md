# A5:2017 Недостатки контроля доступа

| Угрозы/Векторы атаки | Слабые места безопасности  | Нападение |
| -- | -- | -- |
| Уровень доступа Lvl : Уязвимости 2 | Распространённость 2 : Обнаруживаемость 2 | Технический 3 : Бизнес |
| Эксплуатация контроля доступа является основным навыком злоумышленников. [SAST](https://www.owasp.org/index.php/Source_Code_Analysis_Tools) и [DAST](https://www.owasp.org/index.php/Category:Vulnerability_Scanning_Tools) являются инструментами, которые могут обнаруживать отсутствие доступа но не могут проверить, является ли он функциональным, когда он присутствует. Контроль доступа можно обнаружить с помощью ручных средств или, возможно, путем автоматизации для отсутствия контроля доступа в определенных рамках.| Недостатки контроля доступа являются общими из-за отсутствия автоматического обнаружения и отсутствия эффективного функционального тестирования разработчиками приложений. Обнаружение контроля доступа обычно не поддается автоматическому статическому или динамическому тестированию. Ручное тестирование - лучший способ обнаружить отсутствующий или неэффективный контроль доступа, включая HTTP-метод (GET против PUT и т. Д.), контроллер, прямые ссылки на объекты и т. Д. | Техническое воздействие - это злоумышленники, действующие как пользователи или администраторы, или пользователи, использующие привилегированные функции, или создающие, получающие доступ, обновляющие или удаляющие каждую запись. Влияние бизнеса зависит от потребностей защиты приложения и данных. |

## Является ли приложение уязвимым?

Контроль доступа обеспечивает соблюдение политики, при которой пользователи не могут действовать за пределами своих предполагаемых разрешений. Неудачи обычно приводят к несанкционированному раскрытию, изменению или уничтожению всех данных или выполнению бизнес-функции вне пределов доступа пользователя. К уязвимым местам общего доступа относятся:

* Обход проверок контроля доступа путем изменения URL-адреса, состояния внутреннего приложения или HTML-страницы или просто использования специального инструмента атаки API.
* Разрешение изменения первичного ключа в чужой учетной записи пользователя, позволяя просматривать или редактировать чужую учетную запись.
* Повышение уровня привилегий. Действовать как пользователь без входа в систему или действовать как администратор при входе в систему как пользователь.
* Обработка метаданных, такая как воспроизведение или подделка токена контроля доступа JSON (JWT) или куки-файла или скрытого поля, используемых для повышения привилегий или злоупотребления недействительностью JWT
* Неправильная конфигурация CORS допускает несанкционированный доступ к API.
* Принудительный просматр страницы, прошедшей проверку подлинности, как не прошедшей аутентификацию пользователя или привилегированные страницы в качестве стандартного пользователя. Доступ к API с отсутствующими элементами управления доступом для POST, PUT и DELETE.

## Как предотвратить?

Контроль доступа эффективен только в том случае, если он применяется в доверенном серверном коде или API без сервера, где злоумышленник не может изменять проверку контроля доступа или метаданные.

* За исключением общественных ресурсов, отказывать по умолчанию.
* Внедрите механизмы контроля доступа один раз и повторно используйте их во всем приложении, включая минимизацию использования CORS.
* Элементы управления доступом к модели должны обеспечивать соблюдение права собственности на запись, а не принимать, что пользователь может создавать, читать, обновлять или удалять любую запись.
* Уникальные требования к бизнес-ограничениям приложений должны применяться в моделях доменов.
* Отключите список каталогов веб-сервера и убедитесь, что метаданные файлов (например, .git) и файлы резервных копий отсутствуют в веб-корнях.
* Логируйте ошибки управления доступом к журналу, когда это необходимо (например, повторные сбои).
* Ограничте скорость API и доступ к контроллеру для минимизации вреда от автоматизированной системы атак.
* Токены JWT должны быть аннулированы на сервере после выхода из системы.
* Разработчики и тестеры должны разрабатывать функциональный блок контроля доступа и интеграционные тесты.

## Пример сценария атаки

**Сценарий #1**: Приложение использует непроверенные данные в SQL-вызове, который обращается к информации учетной записи:

```
  pstmt.setString(1, request.getParameter("acct"));
  ResultSet results = pstmt.executeQuery();
```

Злоумышленник просто модифицирует параметр «acct» в браузере для отправки любого номера учетной записи по желанию. Если проверка не выполнена должным образом, злоумышленник может получить доступ к любой учетной записи пользователя.

`http://example.com/app/accountInfo?acct=notmyacct`

**Сценарий #2**: Злоумышленник просто заставляет просматривать целевые URL-адреса. Права администратора необходимы для доступа к странице администратора.

```
  http://example.com/app/getappInfo
  http://example.com/app/admin_getappInfo
```

Если неавторизованный пользователь может получить доступ к любой странице, это недостаток. Если не администратор может получить доступ к странице администратора, это недостаток.

## Рекомендации

### OWASP

* [OWASP Проактивные элементы управления: средства контроля доступа](https://www.owasp.org/index.php/OWASP_Proactive_Controls#6:_Implement_Access_Controls)
* [OWASP Стандарт проверки безопасности приложения: контроль доступа V4](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP Руководство по тестированию: авторизация](https://www.owasp.org/index.php/Testing_for_Authorization)
* [OWASP Шпаргалка: Контроль доступа](https://www.owasp.org/index.php/Access_Control_Cheat_Sheet)

### Сторонние

* [CWE-22: Неправильное ограничение пути к ограниченному каталогу («Обход пути»)](https://cwe.mitre.org/data/definitions/22.html)
* [CWE-284: Неправильное управление доступом (авторизация)](https://cwe.mitre.org/data/definitions/284.html)
* [CWE-285: Неправильная авторизация](https://cwe.mitre.org/data/definitions/285.html)
* [CWE-639: Автономный байпас через управляемый пользователем ключ](https://cwe.mitre.org/data/definitions/639.html)
* [PortSwigger: Использование неправильной конфигурации CORS](https://portswigger.net/blog/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
