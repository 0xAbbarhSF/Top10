# A4:2017 Внешние сущности XML (XXE)

| Угрозы/Векторы атаки | Слабые места безопасности           | Нападение               |
| -- | -- | -- |
| Уровень доступа Lvl : Уязвимости 2 | Распространённость 2 : Обнаруживаемость 3 | Технический 3 : Бизнес |
| Атакующие могут использовать уязвимые процессоры XML, если они могут загружать XML или включать в XML-документ враждебный контент, используя уязвимый код, зависимости или интеграцию. | По умолчанию многие старые XML-процессоры позволяют специфицировать внешний объект, URI, который разыменован и оценен во время обработки XML. Инструменты [SAST](https://www.owasp.org/index.php/Source_Code_Analysis_Tools) могут обнаружить эту проблему путем проверки зависимостей и конфигурации. Инструменты [DAST](https://www.owasp.org/index.php/Category:Vulnerability_Scanning_Tools) требуют дополнительных ручных манипуляций для обнаружения и использования этой проблемы. Мануальные тестеры должны быть обучены тому, как тестировать на XXE, так как он не тестировался с 2017 года. | Эти недостатки могут использоваться для извлечения данных, выполнения удаленного запроса с сервера, сканирования внутренних систем, выполнения атаки типа «отказ в обслуживании», а также выполнения других атак. |

## Является ли приложение уязвимым?

Приложения и, в частности, веб-службы на основе XML или последующие интеграции могут быть уязвимы для атаки, если:

* Приложение принимает XML напрямую или загружает XML, особенно из ненадежных источников, или вставляет ненадежные данные в XML-документы, которые затем анализируются процессором XML.
* Любой из XML-процессоров в веб-службах, основанных на приложении или на основе SOAP, использует [определение типа документа (DTDs)](https://en.wikipedia.org/wiki/Document_type_definition). Поскольку точный механизм отключения обработки DTD зависит от процессора, рекомендуется придерживаться такой рекомендации, как [OWASP Cheat Sheet 'XXE Prevention'](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet). 
* Если приложение использует SAML для обработки удостоверений в рамках федеративной безопасности или единого входа (SSO). SAML использует XML для утверждений идентичности и может быть уязвимым.
* Если приложение использует SOAP до версии 1.2, оно, вероятно, подвержено атакам XXE, если XML-объекты передаются в структуру SOAP.
* Быть уязвимым для нападений XXE, вероятно, означает, что приложение уязвимо для атак с отказами в обслуживании, включая атаку Billion Laughs

## Как предотвратить?

Обучение разработчиков имеет важное значение для выявления и смягчения XXE. Кроме того, предотвращение XXE требует:

* По возможности используйте менее сложные форматы данных, такие как JSON, и избегайте сериализации конфиденциальных данных.
* Патч или обновление всех XML-процессоров и библиотек, используемых приложением или базовой операционной системой. Используйте проверки зависимостей. Обновите SOAP до SOAP 1.2 или выше.
* Отключите внешний XML-объект и обработку DTD во всех синтаксических анализаторах XML в приложении в соответствии с  [OWASP Cheat Sheet 'XXE Prevention'](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet). 
* Внедрите положительную («белый список») проверку на стороне сервера, фильтрацию или дезинфекцию, чтобы предотвратить враждебные данные в XML-документах, заголовках или узлах.
* Убедитесь, что функция загрузки XML или XSL-файлов проверяет входящий XML с помощью проверки XSD или аналогичного.
* Инструменты SAST могут помочь обнаружить XXE в исходном коде, хотя обзор ручного кода является лучшей альтернативой в крупных сложных приложениях со многими интеграциями.

Если эти элементы управления невозможны, рассмотрите возможность использования виртуальных патчей, шлюзов безопасности API или брандмауэров веб-приложений (WAF) для обнаружения, мониторинга и блокирования атак XXE.

## Пример сценария атаки

Были обнаружены многочисленные общедоступные проблемы XXE, в том числе атаки на встроенные устройства. XXE встречается во многих неожиданных местах, включая глубоко вложенные зависимости. Самый простой способ - загрузить вредоносный XML-файл, если он принят:

**Сценарий #1**: Злоумышленник пытается извлечь данные с сервера:

```
  <?xml version="1.0" encoding="ISO-8859-1"?>
    <!DOCTYPE foo [
    <!ELEMENT foo ANY >
    <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
    <foo>&xxe;</foo>
```

**Сценарий #2**: Злоумышленник проверяет частную сеть сервера, изменяя приведенную выше строку ENTITY на:
```
   <!ENTITY xxe SYSTEM "https://192.168.1.1/private" >]>
```

**Сценарий #3**: Злоумышленник пытается атаковать по принципу "отказ в обслуживании", включая потенциально бесконечный файл:

```
   <!ENTITY xxe SYSTEM "file:///dev/random" >]>
```

## Рекомендации

### OWASP

* [OWASP Стандарт проверки безопасности приложений](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP Руководство по тестированию: тестирование для внедрения XML](https://www.owasp.org/index.php/Testing_for_XML_Injection_(OTG-INPVAL-008))
* [OWASP Уязвимость в XXE](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing)
* [OWASP Шпаргалка: Профилактика XXE](https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Prevention_Cheat_Sheet)
* [OWASP Шпаргалка: XML безопасность](https://www.owasp.org/index.php/XML_Security_Cheat_Sheet)

### Сторонние

* [CWE-611: Неправильное ограничение XXE](https://cwe.mitre.org/data/definitions/611.html)
* [Billion Laughs Attack](https://en.wikipedia.org/wiki/Billion_laughs_attack)
* [SAML безопасность XML атака через внешний объект](https://secretsofappsecurity.blogspot.tw/2017/01/saml-security-xml-external-entity-attack.html)
* [Обнаружение и использование XXE в интерфейсах SAML](https://web-in-security.blogspot.tw/2014/11/detecting-and-exploiting-xxe-in-saml.html)
