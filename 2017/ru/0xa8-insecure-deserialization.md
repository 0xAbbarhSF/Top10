# A8:2017 Небезопасная десериализация

| Источники угроз/Векторы атак | Недостатки безопасности           | Последствия               |
| -- | -- | -- |
| Зависит от прил. : Сложность эксплуатации 1 | Распространенность 2 : Сложность обнаружения 2 | Технические 3 : Бизнес |
| Эксплуатировать десериализацию сложно, поскольку готовые эксплойты редко можно использовать без изменений или доработок их исходного кода. | Эта проблема включена в Топ-10 на основе [отраслевого опроса](https://owasp.blogspot.com/2017/08/owasp-top-10-2017-project-update.html) , а не количественных данных. Некоторые инструменты могут обнаружить недостатки десериализации, но для подтверждения проблемы часто требуется помощь людей. Ожидается, что данные о распространенности недостатков десериализации будут увеличиваться по мере разработки инструментов, помогающих выявить и устранить эти недостатки.  | Влияние недостатков десериализации нельзя переоценить. Эти недостатки могут привести к удаленным атакам с выполнением кода что, возможно, является одной из самых серьезных атак. Влияние бизнеса зависит от потребностей защиты приложения и данных. |

## Является ли приложение уязвимым?

Приложения и API будут уязвимы, если они десериализуют враждебные или подделанные объекты, предоставленные злоумышленником.

Это может привести к двум основным типам атак:

* Атаки, связанные с объектами и данными, в которых злоумышленник модифицирует логику приложения или запускает произвольное выполнение удаленного кода, если для приложения доступны классы, способные изменять поведение во время или после десериализации.
* Типичные атаки с подделкой данных, такие как атаки, связанные с контролем доступа, в которых используются существующие структуры данных, но содержимое изменяется.

Сериализация может использоваться в приложениях для:

* Удаленная и межпроцессная связь (RPC / IPC)
* Проводные протоколы, веб-службы, мессенджеры
* Кэширование / Сохранение
* Базы данных, кэш-серверы, файловые системы 
* HTTP-файлы cookie, параметры формы HTML, токены аутентификации API 

## Как предотвратить

Единственный безопасный архитектурный шаблон - не принимать сериализованные объекты из ненадежных источников или использовать среды сериализации, которые допускают только примитивные типы данных.

Если это невозможно, рассмотрите следующее:

* Внедрение проверок целостности, таких как цифровые подписи на любых сериализованных объектах, чтобы предотвратить создание враждебных объектов или фальсификацию данных.
* Обеспечение строгих ограничений типа во время десериализации до создания объекта, поскольку код обычно ожидает определенный набор классов. Обход этой техники был продемонстрирован, поэтому полагаться только на этот подход нецелесообразно.
* Изолирующий и работающий код, который, если возможно, десериализуется в средах с низким уровнем привилегий.
* Исключения и неудачи десериализации журналов, например, когда тип ввода не является ожидаемым типом, или десериализация вызывает исключения.
* Ограничение или контроль входящего и исходящего подключения к сети из контейнеров или серверов, которые десериализуются.
* Мониторинг десериализации, оповещение, если пользователь десериализует постоянно.


## Примеры сценариев атак

**Сценарий #1**: Приложение React вызывает набор микросервисов Spring Boot. Будучи функциональными программистами, разработчики пытались обеспечить неизменность своего кода. Решение, с которым они столкнулись, - это сериализовать пользовательское состояние и передавать его с каждым запросом. Злоумышленник замечает подпись объекта «R00» Java и использует инструмент Java Serial Killer для получения удаленного выполнения кода на сервере приложений.

**Сценарий #2**: Форум PHP использует сериализацию объектов PHP, чтобы сохранить «супер» cookie, содержащий идентификатор пользователя, роль, хэш пароля и другое состояние:

`a:4:{i:0;i:132;i:1;s:7:"Mallory";i:2;s:4:"user";i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}`

Злоумышленник изменяет сериализованный объект, чтобы предоставить себе привилегии администратора:
`a:4:{i:0;i:1;i:1;s:5:"Alice";i:2;s:5:"admin";i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}`

## Ссылки

### OWASP

* [OWASP Шпаргалка: Десериализация](https://www.owasp.org/index.php/Deserialization_Cheat_Sheet)
* [OWASP Проактивные элементы управления: проверка всех вводов](https://www.owasp.org/index.php/OWASP_Proactive_Controls#4:_Validate_All_Inputs)
* [OWASP Стандарт проверки безопасности приложений: TBA](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP AppSecEU 2016:  Как пережить апокалипсис Java-десериализации](https://speakerdeck.com/pwntester/surviving-the-java-deserialization-apocalypse)
* [OWASP AppSecUSA 2017: Пятница 13е JSON атаки](https://speakerdeck.com/pwntester/friday-the-13th-json-attacks)

### Сторонние

* [CWE-502: Десереализация непроверенных данных](https://cwe.mitre.org/data/definitions/502.html)
* [Безопасность сортировок в Java](https://github.com/mbechler/marshalsec)
* [OWASP AppSec Cali 2015: Marshalling Pickles](http://frohoff.github.io/appseccali-marshalling-pickles/)
